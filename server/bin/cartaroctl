#!/bin/bash
################################################################################
DIR=`dirname $0`
APP_DIR=$DIR/..

export CARTARO_ENV=$2
if [ "X$CARTARO_ENV" == "X" ]; then
    export CARTARO_ENV="prod"
fi

if [ "X$XDG_RUNTIME_DIR" == "X" ]; then
    XDG_RUNTIME_DIR=/run/user/$UID
fi
PID_FILE=$XDG_RUNTIME_DIR/cartaro-${CARTARO_ENV}.pid

if [ "X$XDG_CONFIG_HOME" == "X" ]; then
    XDG_CONFIG_HOME=$HOME/.config
fi
################################################################################
function app_start
{
    cd $APP_DIR;

    if [ -f $PID_FILE ]; then
        echo "Already running: `cat $PID_FILE`";
    else
        gunicorn --config $XDG_CONFIG_HOME/cartaro-server.py --pid $PID_FILE cartaro.main:flask_app

        sleep 1

        if [ -f $PID_FILE ]; then
            echo "Started: `cat $PID_FILE`"
        else
            echo "Unable to start.";
        fi

    fi
}
################################################################################
function app_stop
{
    if [ -f $PID_FILE ]; then
        kill -TERM `cat $PID_FILE`
        echo "Stopped.";
    else
        echo "Not running.";
    fi
}
################################################################################
function app_status
{
    if [ -f $PID_FILE ]; then
        ps -fp `cat $PID_FILE`
    else
        echo "Not running.";
    fi
}
################################################################################
function usage
{
    echo "$0: Unknown command [$1]";
    echo "Usage: $0 start|stop|restart|status [ENV]"
}
################################################################################
action=$1
case $action in
    start)
        app_start;
    ;;
    stop)
        app_stop;
    ;;
    restart)
        app_stop;
        sleep 1
        app_start;
    ;;
    status)
        app_status;
    ;;
    *) usage $action;
esac
################################################################################
